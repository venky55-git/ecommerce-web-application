{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="admin-dashboard">
    <h2>Admin Dashboard</h2>

    <!-- Key Metrics -->
    <div class="metrics-container">
        <div class="metric-card">
            <div class="metric-value">₹{{ total_sales }}</div>
            <div class="metric-label">Total Sales</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ active_users }}</div>
            <div class="metric-label">Active Users</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="action-btn add-product-btn" onclick="toggleCollapse('addProductForm')">
            + Add Product
        </button>
        <a href="{% url 'all_orders_view' %}" class="action-btn view-orders-btn">View All Orders</a>
        <a href="{% url 'sales_report' %}" class="action-btn sales-report-btn">Sales Report</a>
        <a href="{% url 'pending_orders' %}" class="action-btn pending-orders-btn">Pending Orders</a>
    </div>

    <!-- Add Product Form -->
    <div class="collapse-form" id="addProductForm">
        <div class="form-container">
            <h3>Add New Product</h3>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="submit-btn">Add Product</button>
            </form>
        </div>
    </div>

    <!-- Product Table Display -->
    <h3>Products</h3>
    <div class="product-table-container">
        <table class="product-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Stock</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td><img src="{{ product.image.url }}" class="product-image" alt="{{ product.name }}" style="height:40px;width:auto;"></td>
                    <td>{{ product.name }}</td>
                    <td>{{ product.category }}</td>
                    <td>{{ product.stock }}</td>
                    <td>₹{{ product.price }}</td>
                    <td>
                        <a href="{% url 'edit_product' product.id %}" class="edit-btn">Edit</a>
                        <a href="{% url 'delete_product' product.id %}" class="delete-btn" onclick="return confirm('Are you sure you want to delete this product?')">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="no-products">No products found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Analytics Sections -->
    <div class="analytics-sections">
        <!-- Sales Analytics Section -->
        <div class="analytics-section">
            <h3>Sales Analytics</h3>
            <div class="time-period-selector">
                <button class="time-btn active" data-period="7days">7 Days</button>
                <button class="time-btn" data-period="month">This Month</button>
                <button class="time-btn" data-period="year">This Year</button>
            </div>
            <div class="chart-container">
                <canvas id="salesChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Customer Feedback Section -->
        <div class="analytics-section">
            <h3>Recent Customer Feedback</h3>
            <div class="reviews-grid">
                {% for review in recent_reviews %}
                <div class="review-card">
                    <div class="review-header">
                        <span class="review-rating">{{ review.rating }}/5</span>
                        <span class="review-product">{{ review.product.name }}</span>
                    </div>
                    <p class="review-text">{{ review.comment|truncatechars:100 }}</p>
                    <div class="review-date">{{ review.created_at|date:"M d, Y" }}</div>
                </div>
                {% empty %}
                <p class="no-reviews">No recent reviews available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .product-table-container {
        margin: 24px 0;
        overflow-x: auto;
    }
    .product-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .product-table th, .product-table td {
        padding: 10px 14px;
        border-bottom: 1px solid #eee;
        text-align: left;
    }
    .product-table th {
        background: #f8f9fa;
        font-weight: 600;
    }
    .product-table .product-image {
        height: 40px;
        width: auto;
        border-radius: 4px;
    }
    .edit-btn, .delete-btn {
        padding: 4px 10px;
        margin-right: 4px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.95rem;
    }
    .edit-btn {
        background: #3498db;
        color: #fff;
    }
    .delete-btn {
        background: #e74c3c;
        color: #fff;
    }
    .edit-btn:hover {
        background: #217dbb;
    }
    .delete-btn:hover {
        background: #c0392b;
    }
    .no-products {
        text-align: center;
        color: #888;
        padding: 16px 0;
    }
    /* ... your existing CSS ... */
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
<script>
    // Chart Implementation
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize chart with empty data
        const ctx = document.getElementById('salesChart').getContext('2d');
        const salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sales (₹)',
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });

        // Time period buttons functionality
        const timeButtons = document.querySelectorAll('.time-btn');
        timeButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                timeButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                const period = this.dataset.period;
                loadSalesData(period, salesChart);
            });
        });

        // Load initial data for 7 days
        loadSalesData('7days', salesChart);
    });

    function loadSalesData(period, chart) {
        // Sample data - replace with your actual data fetching logic
        let labels = [];
        let data = [];
        
        // Generate sample data based on period
        if (period === '7days') {
            labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Today'];
            data = [1200, 1900, 1500, 2000, 1800, 2200, 2500];
        } else if (period === 'month') {
            labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            data = [7500, 8200, 9100, 8800];
        } else if (period === 'year') {
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            data = [28000, 32000, 35000, 38000, 42000, 45000, 48000, 50000, 52000, 55000, 58000, 60000];
        }

        // Update chart data
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
        
        /* 
        // For actual implementation, use this fetch code instead of sample data:
        fetch(`/api/sales-data/?period=${period}`)
            .then(response => response.json())
            .then(data => {
                chart.data.labels = data.labels;
                chart.data.datasets[0].data = data.values;
                chart.update();
            });
        */
    }

    function toggleCollapse(id) {
        const element = document.getElementById(id);
        element.classList.toggle('show');
    }
</script>
{% endblock %}